<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Manager UI/UX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .category-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .category-button:hover {
            background-color: #dbeafe;
        }
        .category-button.active {
            font-weight: 700;
            background-color: #bfdbfe;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .map-point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ef4444;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .map-point.glow {
            background-color: #3b82f6;
            box-shadow: 0 0 20px 5px #3b82f6, 0 0 10px 2px #60a5fa;
            z-index: 20;
        }
        .map-point.nearest {
            background-color: #10b981;
            box-shadow: 0 0 20px 5px #10b981, 0 0 10px 2px #34d399;
            z-index: 30;
        }
        .grid-line {
            position: absolute;
            background-color: #e5e7eb;
        }
        .grid-line.x { width: 100%; height: 1px; }
        .grid-line.y { height: 100%; width: 1px; }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -4px;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .vertical-slider-wrapper {
            width: 2rem;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #category-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%; 
            height: 1.5rem; 
            
            background: transparent;
            position: absolute;
            transform: rotate(-90deg); 
            transform-origin: center center;
            margin: 0;
            cursor: pointer;
        }
        #category-slider::-webkit-slider-runnable-track {
            background: #ccc;
            height: 8px; 
            border-radius: 4px;
        }
        #category-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        #category-scroll-window {
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        #full-category-list {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.1s ease-out;
        }

        @media (max-width: 768px) {
            #main-container {
                flex-direction: column;
            }
            #control-panel {
                width: 100%;
                height: 50vh;
            }
            #map-container {
                width: 100%;
                height: 50vh;
            }
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div id="main-container" class="flex h-full">

        <div id="control-panel" class="w-full md:w-3/10 bg-white shadow-xl flex flex-col p-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Category Manager</h1>

            <div id="ui-view" class="flex flex-col flex-grow">
            </div>

            <div id="global-actions" class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <button onclick="showAddCategoryUI()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Add New Category
                </button>
                <button onclick="removeAllCategories()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Remove All Categories
                </button>
            </div>
        </div>

        <div id="map-container" class="w-full md:w-7/10 bg-gray-50 flex items-center justify-center p-2 relative overflow-hidden">
            <div class="absolute inset-0 p-8">
                <div id="map-grid" class="relative w-full h-full border border-gray-300 rounded-lg overflow-hidden shadow-inner">
                    <div class="grid-line x" style="top: 50%;"></div>
                    <div class="grid-line y" style="left: 50%;"></div>
                    <div class="grid-line x" style="top: 25%;"></div>
                    <div class="grid-line x" style="top: 75%;"></div>
                    <div class="grid-line y" style="left: 25%;"></div>
                    <div class="grid-line y" style="left: 75%;"></div>

                    <div id="point-layer" class="absolute inset-0"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="point-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Search Nearest Neighbor</h3>
            <div class="space-y-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Point ID (Search Source)</label>
                    <input type="text" id="search-point-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. p123">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                <button id="modal-submit-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">Search</button>
            </div>
        </div>
    </div>

    <script>
        let currentX = 50;
        let currentY = 50;
        
        let categoryItemHeight = 56; 
        
        let categories = [
            'Restroom', 'Exit', 'Cafeteria', 'First Aid', 'Locker Room', 
            'Security', 'Stairs', 'Elevator', 'Meeting Room', 'IT Support',
            'Warehouse', 'Office', 'Data Center', 'Lobby'
        ];

        let points = [
            { id: 'p1', x: 10, y: 10, category: 'Restroom' },
            { id: 'p2', x: 90, y: 10, category: 'Exit' },
            { id: 'p3', x: 50, y: 20, category: 'Cafeteria' },
            { id: 'p4', x: 20, y: 40, category: 'First Aid' },
            { id: 'p5', x: 80, y: 40, category: 'Locker Room' },
            { id: 'p6', x: 10, y: 70, category: 'Security' },
            { id: 'p7', x: 90, y: 70, category: 'Stairs' },
            { id: 'p8', x: 50, y: 90, category: 'Elevator' },
            { id: 'p9', x: 30, y: 50, category: 'Meeting Room' },
            { id: 'p10', x: 70, y: 50, category: 'IT Support' },
            { id: 'p11', x: 15, y: 85, category: 'Security' },
            { id: 'p12', x: 85, y: 5, category: 'Restroom' },
        ];

        let uiState = 'main';
        let activeCategory = null;
        let categoryScrollPosition = 0;

        const uiView = document.getElementById('ui-view');
        const pointLayer = document.getElementById('point-layer');
        const pointModal = document.getElementById('point-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const searchPointId = document.getElementById('search-point-id');

        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function generateId() {
            return 'p' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function updateCategoryScroll(sliderValue) {
            categoryScrollPosition = parseFloat(sliderValue);
            
            const listEl = document.getElementById('full-category-list');
            const windowEl = document.getElementById('category-scroll-window');

            if (!listEl || !windowEl) return;
            
            const totalListHeight = listEl.offsetHeight;
            const windowHeight = windowEl.offsetHeight;

            if (totalListHeight <= windowHeight) {
                listEl.style.transform = `translateY(0px)`;
                return;
            }

            const maxScrollDistance = totalListHeight - windowHeight;
            
            const translateY = -(maxScrollDistance * (categoryScrollPosition / 100));

            listEl.style.transform = `translateY(${translateY}px)`;
        }

        const debouncedUpdateScroll = debounce(() => {
            if (uiState === 'main') {
                 renderMainView();
            }
        }, 150);
        
        window.addEventListener('resize', debouncedUpdateScroll);


        function updateCoordinateState(value, axis) {
            const intValue = parseInt(value);
            if (axis === 'x') {
                currentX = intValue;
                const xSpan = document.getElementById('detail-x-value');
                if (xSpan) xSpan.textContent = `${currentX}%`;
            } else if (axis === 'y') {
                currentY = intValue;
                const ySpan = document.getElementById('detail-y-value');
                if (ySpan) ySpan.textContent = `${currentY}%`;
            }
            renderMapPoints();
        }

        function calculateDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function findNearestNeighbor(sourcePointId) {
            const sourcePoint = points.find(p => p.id === sourcePointId);
            if (!sourcePoint) return null;

            let minDistance = Infinity;
            let nearestId = null;

            for (const targetPoint of points) {
                if (sourcePoint.id === targetPoint.id) continue;

                const distance = calculateDistance(
                    sourcePoint.x, sourcePoint.y,
                    targetPoint.x, targetPoint.y
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    nearestId = targetPoint.id;
                }
            }
            return nearestId;
        }

        function renderMainView() {
            uiState = 'main';
            
            const listContent = categories.map(cat => {
                return `
                    <div style="min-height: ${categoryItemHeight}px;" class="flex justify-between items-center bg-gray-100 rounded-lg shadow-sm hover:shadow-md transition duration-150 mb-2">
                        
                        <button 
                            class="category-button w-full text-left p-3 text-gray-700 rounded-l-lg ${activeCategory === cat ? 'active' : ''}"
                            onclick="toggleCategoryFilter('${cat}')"
                        >
                            ${cat}
                        </button>
                        
                        <button 
                            class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-r-lg font-bold transition duration-150"
                            onclick="renderCategoryDetails('${cat}')"
                            title="Manage ${cat}"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500 text-center py-4">No categories added yet.</p>';
            
            uiView.innerHTML = `
                <div class="flex-grow flex flex-col space-y-4">
                    <p class="text-sm text-gray-500">
                        Total Categories: <span class="font-bold text-gray-700">${categories.length}</span>. 
                        Scroll list size adapts to the window height.
                    </p>

                    <div class="flex flex-row items-start space-x-4 flex-grow">
                        
                        <div id="category-scroll-window" class="flex-grow flex flex-col justify-start space-y-2 rounded-lg shadow border border-gray-200">
                            <div id="full-category-list">
                                ${listContent}
                            </div>
                        </div>
                        
                        <div class="vertical-slider-wrapper">
                            <input type="range" id="category-slider" 
                                min="0" max="100" 
                                value="${categoryScrollPosition}"
                                oninput="updateCategoryScroll(this.value)"
                                disabled
                            >
                        </div>
                    </div>
                </div>
            `;
            
            const sliderEl = document.getElementById('category-slider');
            const windowEl = document.getElementById('category-scroll-window');
            const listEl = document.getElementById('full-category-list');

            if (sliderEl && windowEl && listEl) {
                const totalListHeight = listEl.offsetHeight;
                const windowHeight = windowEl.offsetHeight;
                const isScrollable = totalListHeight > windowHeight;

                if (isScrollable) {
                    sliderEl.removeAttribute('disabled');
                    sliderEl.style.width = `${windowHeight}px`; 
                } else {
                    sliderEl.setAttribute('disabled', 'true');
                    categoryScrollPosition = 0; 
                    listEl.style.transform = `translateY(0px)`;
                }
            }

            updateCategoryScroll(categoryScrollPosition);
            renderMapPoints();
        }

        function renderAddCategory() {
            uiState = 'addCategory';
            uiView.innerHTML = `
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <button onclick="renderMainView()" class="flex items-center text-blue-500 hover:text-blue-700 mb-4 transition duration-150 font-semibold">
                        &larr; Back to Main
                    </button>
                    <h2 class="text-xl font-semibold mb-4">New Category Name</h2>
                    <input type="text" id="new-category-name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. Vending Dustbin">
                    <button onclick="addCategory()" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-150 shadow-md">
                        OKK (Create Category)
                    </button>
                </div>
            `;
        }

        function renderCategoryDetails(categoryName) {
            activeCategory = categoryName;
            uiState = 'categoryDetails';

            const categoryPoints = points.filter(p => p.category === categoryName);

            uiView.innerHTML = `
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col h-full">
                    <button onclick="renderMainView()" class="flex items-center text-blue-500 hover:text-blue-700 mb-4 transition duration-150 font-semibold">
                        &larr; Back to Main UI
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 underline">${categoryName.toUpperCase()}</h2>

                    <div class="space-y-4 mb-6 p-3 bg-white rounded-lg shadow border">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                X Coordinate (0-100%) 
                                <span id="detail-x-value" class="font-bold text-indigo-600">${currentX}%</span>
                            </label>
                            <input type="range" id="detail-point-x" min="0" max="100" value="${currentX}" 
                                class="mt-1 block w-full appearance-none bg-gray-200 h-2 rounded-full cursor-pointer" 
                                oninput="updateCoordinateState(this.value, 'x')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                Y Coordinate (0-100%) 
                                <span id="detail-y-value" class="font-bold text-indigo-600">${currentY}%</span>
                            </label>
                            <input type="range" id="detail-point-y" min="0" max="100" value="${currentY}" 
                                class="mt-1 block w-full appearance-none bg-gray-200 h-2 rounded-full cursor-pointer" 
                                oninput="updateCoordinateState(this.value, 'y')">
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <button onclick="addPoint('${categoryName}')" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Add Point at Current (X, Y)
                        </button>
                        <button onclick="removePoint('${categoryName}')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Remove Point at Current (X, Y)
                        </button>
                        <button onclick="showSearchModal()" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Search Nearest Neighbor (Requires ID)
                        </button>
                    </div>

                    <h3 class="text-lg font-semibold mb-2">Points in this Category (${categoryPoints.length})</h3>
                    <div class="flex-grow overflow-y-auto space-y-1 p-2 bg-white rounded-lg border">
                        ${categoryPoints.map(p => `
                            <p class="text-sm text-gray-600 p-1 border-b last:border-b-0">
                                <span class="font-mono text-xs text-gray-500">${p.id}</span>: X=${p.x}%, Y=${p.y}%
                            </p>
                        `).join('') || '<p class="text-gray-500 text-center py-4">No points for this category yet.</p>'}
                    </div>

                    <button onclick="deleteCategory('${categoryName}')" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        Delete Category (${categoryName})
                    </button>
                </div>
            `;
            toggleCategoryFilter(categoryName); 
        }
        
        function showAddCategoryUI() {
            renderAddCategory();
        }

        function addCategory() {
            const nameInput = document.getElementById('new-category-name');
            const newName = nameInput.value.trim();

            if (!newName) {
                console.error('Category name cannot be empty.');
                return;
            }
            if (categories.includes(newName)) {
                console.error('Category already exists.');
                return;
            }

            categories.push(newName);
            nameInput.value = '';
            renderMainView();
        }

        function deleteCategory(name) {
            const confirmed = window.prompt(`Are you sure you want to delete category "${name}" and ALL its points? Type YES to confirm.`);
            if (confirmed && confirmed.toUpperCase() === 'YES') {
                categories = categories.filter(c => c !== name);
                points = points.filter(p => p.category !== name);
                activeCategory = null;
                categoryScrollPosition = 0;
                renderMainView();
            } else {
                console.log('Category deletion cancelled.');
            }
        }

        function removeAllCategories() {
            const confirmed = window.prompt("Are you sure you want to delete ALL categories and ALL associated points? This cannot be undone. Type YES to confirm.");
            if (confirmed && confirmed.toUpperCase() === 'YES') {
                categories = [];
                points = [];
                activeCategory = null;
                categoryScrollPosition = 0;
                renderMainView();
            } else {
                console.log('Bulk deletion cancelled.');
            }
        }
        
        function toggleCategoryFilter(catName) {
            if (uiState !== 'main') {
                activeCategory = catName;
            } else {
                activeCategory = activeCategory === catName ? null : catName;
            }
            renderMainView();
            renderMapPoints();
        }

        function addPoint(categoryName) {
            points.push({ id: generateId(), x: currentX, y: currentY, category: categoryName });
            renderCategoryDetails(categoryName);
        }

        function removePoint(categoryName) {
            const index = points.findIndex(p => p.x === currentX && p.y === currentY && p.category === categoryName);

            if (index !== -1) {
                points.splice(index, 1);
                renderCategoryDetails(categoryName);
            } else {
                console.error(`Point at (${currentX}%, ${currentY}%) not found in category ${categoryName}.`);
                const statusMessage = document.createElement('div');
                statusMessage.className = 'fixed top-4 right-4 bg-yellow-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300';
                statusMessage.textContent = `Point at (${currentX}%, ${currentY}%) not found in category ${categoryName}.`;
                document.body.appendChild(statusMessage);
                setTimeout(() => statusMessage.remove(), 4000);
            }
        }

        function hideModal() {
            pointModal.classList.add('hidden');
            searchPointId.value = '';
            clearSearchHighlight();
        }

        function showSearchModal() {
            modalTitle.textContent = `Search Nearest Neighbor (All Points)`;

            clearSearchHighlight();

            modalSubmitBtn.onclick = () => {
                const sourceId = searchPointId.value.trim();
                
                if (!sourceId) {
                    const statusMessage = document.createElement('div');
                    statusMessage.className = 'fixed top-4 right-4 bg-yellow-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300';
                    statusMessage.textContent = `Please enter a Point ID to search.`;
                    document.body.appendChild(statusMessage);
                    setTimeout(() => statusMessage.remove(), 3000);
                    return;
                }
                
                const nearestId = findNearestNeighbor(sourceId);

                if (nearestId) {
                    highlightNearest(sourceId, nearestId);
                    hideModal();
                } else {
                    const statusMessage = document.createElement('div');
                    statusMessage.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300';
                    statusMessage.textContent = `Source ID "${sourceId}" not found or no other points exist.`;
                    document.body.appendChild(statusMessage);
                    setTimeout(() => statusMessage.remove(), 4000);
                }
            };
            pointModal.classList.remove('hidden');
        }


        // --- MAP RENDERING ---

        function clearSearchHighlight() {
            // Remove all glow and nearest classes from all points
            document.querySelectorAll('.map-point').forEach(el => {
                el.classList.remove('glow', 'nearest');
            });
        }

        function highlightNearest(sourceId, nearestId) {
            clearSearchHighlight();
            
            // Highlight source point with 'glow'
            const sourceEl = document.querySelector(`.map-point[data-point-id="${sourceId}"]`);
            if (sourceEl) {
                sourceEl.classList.add('glow');
            }
            
            // Highlight nearest point with 'nearest'
            const nearestEl = document.querySelector(`.map-point[data-point-id="${nearestId}"]`);
            if (nearestEl) {
                nearestEl.classList.add('nearest');
            }
        }

        function renderMapPoints() {
            pointLayer.innerHTML = '';
            const filterCategory = activeCategory;

            points.forEach(point => {
                // Determine if point should be visible based on activeCategory filter
                const isVisible = !filterCategory || point.category === filterCategory;

                if (isVisible) {
                    const pointEl = document.createElement('div');
                    pointEl.className = 'map-point';
                    pointEl.setAttribute('data-point-id', point.id);
                    pointEl.setAttribute('data-category', point.category);
                    pointEl.style.left = `${point.x}%`;
                    pointEl.style.top = `${point.y}%`;

                    // Add interaction only when on the main screen OR if it's the category we are inspecting
                    if (uiState === 'main' || (uiState === 'categoryDetails' && point.category === activeCategory)) {
                        pointEl.onclick = () => {
                            // In main view, clicking a point should open its detail view (or set coordinates)
                            if (uiState === 'main') {
                                currentX = point.x;
                                currentY = point.y;
                                // Update the detail sliders *if* in detail view
                                const xSlider = document.getElementById('detail-point-x');
                                const ySlider = document.getElementById('detail-point-y');
                                if (xSlider) xSlider.value = currentX;
                                if (ySlider) ySlider.value = currentY;
                                
                                // Update spans if they exist
                                const xSpan = document.getElementById('detail-x-value');
                                if (xSpan) xSpan.textContent = `${currentX}%`;
                                const ySpan = document.getElementById('detail-y-value');
                                if (ySpan) ySpan.textContent = `${currentY}%`;
                                
                                // Navigate to details view for that category
                                renderCategoryDetails(point.category);
                            }
                            // In details view, clicking the point could highlight it or show its specific info (omitted for simplicity)
                        };
                        pointEl.title = `ID: ${point.id} | Category: ${point.category} | (${point.x}%, ${point.y}%)`;
                    }

                    // Add specific class for the current global cursor if applicable (though usually this is handled by the glow/nearest)
                    // For now, we just render them visible

                    pointLayer.appendChild(pointEl);
                }
            });

            // Re-apply any existing search highlights after re-rendering
            const glowEl = document.querySelector('.map-point.glow');
            const nearestEl = document.querySelector('.map-point.nearest');

            if (glowEl && glowEl.getAttribute('data-point-id')) {
                glowEl.classList.add('glow');
            }
            if (nearestEl && nearestEl.getAttribute('data-point-id')) {
                nearestEl.classList.add('nearest');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listener for the modal submit button
            document.getElementById('modal-submit-btn').onclick = () => {
                // This logic is already inside showSearchModal, but we make sure the button is wired
                // The actual submit handler is set within showSearchModal based on the context (Nearest Neighbor)
                const sourceId = searchPointId.value.trim();
                if (!sourceId) {
                    const statusMessage = document.createElement('div');
                    statusMessage.className = 'fixed top-4 right-4 bg-yellow-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300';
                    statusMessage.textContent = `Please enter a Point ID to search.`;
                    document.body.appendChild(statusMessage);
                    setTimeout(() => statusMessage.remove(), 3000);
                    return;
                }
                
                const nearestId = findNearestNeighbor(sourceId);

                if (nearestId) {
                    highlightNearest(sourceId, nearestId);
                    hideModal();
                } else {
                    const statusMessage = document.createElement('div');
                    statusMessage.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300';
                    statusMessage.textContent = `Source ID "${sourceId}" not found or no other points exist.`;
                    document.body.appendChild(statusMessage);
                    setTimeout(() => statusMessage.remove(), 4000);
                }
            };

            // Initial Render
            renderMainView();
        });
    </script>
</body>
</html>